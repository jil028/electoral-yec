---
title: "Visualization: Partial Thesis"
author: "Jiayi Li"
date: "2022-11-18"
output: html_document
---
Purpose: to clean data and create figures in the background and methods sections of the partial thesis.

# load packages

```{r}
library(readxl)
library(tidyverse)
library(vistime)
#library(Amelia)
library(modelsummary)
library(kableExtra)
library(glue)

source_dir <- "/Users/jiayili/Desktop/honors-thesis-main/01-outputs/raw-data"
```


# figure: trend of turnout rates of elections in Hong Kong, 2011-2019
```{r}
############
# Figure x #
############

# create a tibble for overall turnouts (sources: HK SAR government's websites)
hk_elections_turnouts <-
  tribble(
    ~year, ~type, ~turnout,
    "2011", "District Council Election", 41.49,
    "2012", "Legislative Council Election", 53.05, 
    "2015", "District Council Election", 47.01,
    "2016", "Legislative Council Election", 58.28,
    "2019", "District Council Election", 71.23,
    "2021", "Legislative Council Election", 30.20
  )

plt_trend_turnouts <- 
  hk_elections_turnouts %>%
  ggplot(aes(x = year, y = turnout, label = turnout)) + 
  geom_point(stat = "identity", color = "steelblue4", 
             fill = "steelblue4", size = 11)  +
  geom_segment(aes(y = 0, 
                   x = year, 
                   yend = turnout, 
                   xend = year), 
               color = "steelblue4") +
  geom_text(color = "white", size = 3) +
  labs(y = "Cumulative turnourt rate (%)",
       x = "") +
  theme_bw() +
  ylim(0, 90) +
  facet_wrap(~type, nrow = 2, scales = "free_y",
             labeller = as_labeller(c("District Council Election" = "District Council Elections",
                                      "Legislative Council Election" = "Legislative Council Elections")))+
  coord_flip() +
  theme(axis.text = element_text(size = 14),
        strip.text = element_text(size = 14),
        axis.title.x = element_text(size = 14))
```


# figure: electoral democracy index
# source: v-dem (https://v-dem.net/data/the-v-dem-dataset/country-year-v-dem-core/)

```{r}
############
# Figure x #
############

vdem_raw <-
  read.csv(glue("{source_dir}/Country_Year_V-Dem_Core_CSV_v12/V-Dem-CY-Core-v12.csv"))

vdem_hk_raw <-
  vdem_raw %>%
  filter(country_name == "Hong Kong") %>%
  filter(year >= 1980)

# set the label function for significant digits
scaleFUN <- function(x) sprintf("%.1f", x)

# plot
plt_elect_dem_index <- 
  vdem_hk_raw %>%
  ggplot(aes(x = year, y = v2x_polyarchy)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(labels = scaleFUN, limits = c(0, 1)) +
  # annotate important events
  geom_vline(xintercept = 1997, linetype = 2, color = "coral3") +
  annotate("text", x = 2003.5, y = 0.8, 
           label = "1997: Handover of Hong Kong",
           colour = "coral3", size = 5) +
  geom_vline(xintercept = 2014, linetype = 2, color = "coral3") +
  annotate("text", x = 2008, y = 0.15, 
           label = "2014: Umbrella Movement",
           colour = "coral3", size = 5) +
  # adjust themes
  theme_bw() +
  theme(axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 14),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_blank()) +
  ylab("Electoral democracy index")
```


# figure: heatmaps

```{r}
############
# Figure x #
############

# load raw hk map
hk_shp <- 
  read_sf("~/Dropbox/Mac/Downloads/Hong_Kong_18_Districts (1)/HKDistrict18.shp") %>%
  # standardize administrative district names
  mutate(
    ENAME = paste(ENAME, "DISTRICT"),
    ENAME = 
      case_when(
        row_number() == 6 ~ "CENTRAL AND WESTERN DISTRICT",
        row_number() == 17 ~ "DAI PO DISTRICT",
        TRUE ~ as.character(ENAME)
      )
  )

# load final openrice data sets
df_openrice <- read.csv()

df_openrice <-
  final_openrice %>%
  mutate(
    ENAME = str_to_upper(dce_constituency)
  ) 

op_total_df <- 
  df_openrice %>%
  group_by(ENAME) %>%
  summarise(total_restaurants = n()) %>%
  ungroup() %>%
  st_drop_geometry()

op_count_df <- 
  df_openrice %>%
  group_by(ENAME, ideo_text) %>%
  summarise(n_restaurants = n()) %>%
  ungroup() %>%
  st_drop_geometry()

# keep only yellow restaurants
df_openrice <-
  left_join(op_count_df, op_total_df, by = "ENAME") %>%
  mutate(
    prop = n_restaurants / total_restaurants
  ) %>%
  filter(ideo_text == "Yellow")

out <-
  hk_shp %>%
  left_join(df_openrice, by = "ENAME")

heatmap_yellow <-
  ggplot(out) +
  geom_sf(aes(fill = prop)) +
  scale_fill_gradient(low = "white", high = "gold") +
  theme_bw() +
  labs(
    fill = ''
  ) +
  theme(legend.text = element_text(size=8))
  
pdf('heatmap_yellow.pdf', width = 9, height = 4.5)
heatmap_yellow
dev.off()


# keep only blue restaurants
df_openrice <-
  left_join(op_count_df, op_total_df, by = "ENAME") %>%
  mutate(
    prop = n_restaurants / total_restaurants
  ) %>%
  filter(ideo_text == "Blue")

out <-
  hk_shp %>%
  left_join(df_openrice, by = "ENAME")

heatmap_blue <-
  ggplot(out) +
  geom_sf(aes(fill = prop)) +
  scale_fill_gradient(low = "white", high = "cornflowerblue") +
  theme_bw() +
  labs(
    fill = ''
  ) +
  theme(legend.text = element_text(size=8))

pdf('heatmap_blue.pdf', width = 9, height = 4.5)
heatmap_blue
dev.off()
```


# figure: grouped bar chart of politicized restaurants by political ideology

```{r}
##############
## Figure x ##
##############

# load raw data
openrice_raw <- 
    read.csv(glue("{source_dir}/openrice_final_raw.csv"))

# group data and get summary stats
out <-
  openrice_raw %>%
  group_by(dce_constituency, ideo_text) %>%
  summarise(
    count = n()
   )
   
# set the breaks and ticklabels
breaks <- c(seq(0, 500, by = 50))
ticklabels <- c('0','50','100','150', '200',"250", '300', "350", "400", "450", "500")

# make the bar chart
bar_by_ideo <-
    out %>%
    # sorted bars
    ggplot(aes(x = reorder(dce_constituency, count), y = count, fill = ideo_text, label = count)) +
    geom_col(width = 0.7, position = position_dodge(0.7), alpha = 0.7) +
    geom_text(position = position_dodge(width = 0.9),
              hjust = -0.5, size = 2.5) +
    scale_y_continuous(limits = c(0, 460), expand = c(0,0), 
                       breaks = breaks, labels = ticklabels, 
                       sec.axis = sec_axis(~ . * 1, breaks = breaks, labels = ticklabels)) + 
    coord_flip() +
    # recode the legend
    scale_fill_manual(name = "Political support",
                      labels = c("Blue (pro-Beijing)", "Yellow (pro-democracy)"),
                      values=c("cornflowerblue", "gold")) +
    # adjust themes
    theme_minimal() +
    theme(text = element_text(size = 12)) +
    theme(legend.direction = "horizontal", 
          legend.position = "bottom",
          legend.box = "horizontal",
          panel.grid.major = element_blank()) +
    guides(fill = guide_legend(override.aes = list(size = 4.5))) +
    ylab("Number of restaurants") +
    xlab(" ")
```

# figure: timeline of the development of the YEC

```{r}
##############
## Figure x ##
##############

# create a tibble for event data
df_timeline_2019 <-
  tribble(
    ~start_date, ~event, ~type, ~end_date,
    "2019-03-15", "Beginning of the Anti-ELAB Movement", "Sit-in protests", NA_character_,
    "2019-06-09", "Escalation of protests", "Massive gatherings", "2019-12-31", # set to end on 12/31 given that COVID-19 started
    "2019-07-01", "The firing of the Yoshinoya staff", "Development of the YEC", NA_character_,
    "2019-10-10", '"Day of Thanks"', "Development of the YEC", NA_character_,
    "2019-10-26", '"Shopping Spree Day"', "Development of the YEC", NA_character_,
    "2019-11-24", "District Council Election", "Election", "2019-11-24"
  )

timeline_2019 <-
  gg_vistime(df_timeline_2019, col.event = "event", 
             col.group = "type", optimize_y = F,
             col.start = "start_date", col.end = "end_date", 
             show_labels = FALSE) +
  theme(axis.text.y = element_text(size = 12),
        axis.text.x = element_text(size = 12)) +
  # repel text labels
  geom_text_repel(data = p$layers[[3]]$data,
                  label = p$layers[[3]]$data$label, 
                  size = 4, 
                  color = "black")
```


# figure: protest sites
# source: HKU

```{r}
protests <-
  read_sf("/Users/jiayili/Desktop/honors-thesis-main/01-outputs/raw-data/event_v2/event.shp")

protest_map <-
  ggplot() +
  geom_sf(data = hk_shp) +
  geom_sf(data = out, aes(fill = prop)) +
  scale_fill_gradient(low = "white", high = "gold") +
  geom_sf(data = protests, shape = 9, color = "orangered3", 
          size = 2, alpha = 0.5) +
  theme_bw() +
  labs(
    fill = ''
  ) +
  theme(legend.text = element_text(size=8))
```




